#! /bin/sh

echo "=================== INITALIZING ==================="

. /usr/local/bin/inc

mkdir -p ${BASE}/pems ${BASE}/rainloop ${BASE}/sasl2 ${BASE}/homedirs ${BASE}/mailboxes
chmod 755 ${BASE}/homedirs ${BASE}/mailboxes ${BASE}/rainloop

for file in group passwd shadow
do
	cp -a ${SRC}/uid/${file} /run/${file}
done

if ! test -d ${BASE}/service
	then
		cp -a /usr/local/etc/service ${BASE}/service
	fi
if ! test -f ${BASE}/service/used_domains.json
	then
		echo "{}" > ${BASE}/service/used_domains.json
	fi
chown -R 850: ${BASE}/service

/usr/local/python/doms_runner.py -O remake_unix_files
/usr/local/python/root_runner.py -O install_unix_files

mkdir -p /run/exec/root /run/exec/doms /run/sessions
chmod 777 /run/exec/root /run/exec/doms /run/sessions
chown service: /run/exec/doms


${PYBASE}/merge_templates.py
. /run/templates/__include__
/usr/local/python/doms_runner.py -O remake_mail_files
/usr/local/python/root_runner.py -O install_mail_files

if ! grep -q '^manager:' /etc/passwd
	then
		/usr/local/bin/user_create "manager" "12345" >/dev/null 2>&1
	fi

mkdir -p /run/pems
chmod 755 /run/pems
chown root:mail /run/pems

if ! test -s ${BASE}/pems/server.pem
	then
		${PYBASE}/make_server_pem.py \
			-f ${POLICY_SITE_FQDN} \
			-c ${POLICY_SITE_COUNTRY} \
			-l ${POLICY_SITE_LOCATION} \
			-o ${POLICY_SITE_ORG} \
			-u ${POLICY_SITE_ORG_UNIT} \
			-s ${POLICY_SITE_STATE} > ${BASE}/pems/server.pem
	fi
cp -a ${BASE}/pems/server.pem /run/pems/server.pem
chmod 644 /run/pems/server.pem


if ! test -f /etc/sasl2/smtpd.conf
	then
		{
		echo "pwcheck_method: auxprop"
		echo "auxprop_plugin: sasldb"
		echo "mech_list: PLAIN LOGIN CRAM-MD5 DIGEST-MD5 NTLM"
		} > /etc/sasl2/smtpd.conf
	fi

for dir in spool master data
do
	mkdir -p ${BASE}/postfix/${dir}
	chown postfix:mail ${BASE}/postfix/${dir}
done
chown root:mail ${BASE}/postfix/spool
chmod 755 ${BASE}/postfix/spool
postfix set-permissions >/dev/null 2>&1


for file in transport virtual
do
	pfx="${BASE}/postfix/data/${file}"
	touch ${pfx}
	rm -f ${pfx}.lmdb
	postmap ${BASE}/postfix/data/${file}
done
chown -R postfix: ${BASE}/postfix/.


mkdir /run/nginx; chown nginx: /run/nginx

if ! test -f ${BASE}/rainloop/EMPTY
	then
		cp -a ${SRC}/data/. ${BASE}/rainloop/
	fi

RAINLOOP="${BASE}/rainloop/_data_/_default_"
dst="${RAINLOOP}/configs/application.ini"
src="/run/templates/application.ini"
if ! test -f ${dst}; then cp -a ${src} ${dst}; fi

dst="${RAINLOOP}/domains/${POLICY_DEFAULT_MAIL_DOMAIN}.ini"
src="/run/templates/webmail.localhost.ini"
if ! test -f ${dst}; then rm -f ${RAINLOOP}/domains/*; cp -a ${src} ${dst}; fi

chmod 700 ${BASE}/rainloop
chown -R rainloop: ${BASE}/rainloop

echo "=================== STARTING ==================="
exec /sbin/init
