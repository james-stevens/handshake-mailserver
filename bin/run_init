#! /bin/sh

mkdir -p /opt/data/pems /opt/data/etc
for file in passwd shadow
do
	if ! test -f /opt/data/etc/${file}
		then
			cp -a /usr/local/etc/${file} /opt/data/etc/${file}
		fi
done


if ! test -s /opt/data/pems/server.pem
	then
		/usr/local/python/make_server_pem.py -f lord.webmail -c GB -l London -o dot-WebMail -u Mail -s London > /opt/data/pems/server.pem
	fi


chown root:mail /opt/data/pems/server.pem

for dir in spool master data mailboxes
do
	mkdir -p /opt/data/postfix/${dir}
	chown postfix:mail /opt/data/postfix/${dir}
done

if ! test -f /opt/data/postfix/data/relay_domains
	then
		touch /opt/data/postfix/data/relay_domains
	fi

postalias /opt/data/postfix/data/relay_domains
postfix set-permissions


mkdir /run/nginx; chown nginx: /run/nginx

mkdir -p /opt/data/rainloop
cp -a /usr/local/etc/data/* /opt/data/rainloop/
chmod 700 /opt/data/rainloop
chown nobody:nogroup /opt/data/rainloop

exec /sbin/init
